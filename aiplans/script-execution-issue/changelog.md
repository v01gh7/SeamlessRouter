# Changelog: Исправление проблемы с выполнением скриптов

## 2025-12-23: Создание плана
- Создан подробный план анализа и решения проблемы
- Проанализирована текущая архитектура роутера
- Выявлены потенциальные причины проблемы:
  1. Кэш скриптов (`scriptCache`) не очищается при удалении скриптов
  2. Логика `removeExistingScript` удаляет скрипты из DOM, но не из кэша
  3. `appendFreshScript` проверяет кэш и пропускает выполнение, если скрипт уже в кэше

## 2025-12-23: Ответы на открытые вопросы
- Изучил `sandbox.ts`: `purgeAllScripts()` очищает DOM и песочницу, но не `scriptCache`
- Проверил весь код: `scriptCache` используется только в `dom.ts`
- Проанализировал логику для inline/external скриптов: одинаковая логика кэширования
- Определил корневую причину: `scriptCache` не очищается при удалении скриптов
- Разработал план тестирования без dev сервера

## Выводы:
1. **Корневая причина:** `scriptCache` не очищается при удалении скриптов
2. `purgeAllScripts()` очищает DOM и песочницу, но не кэш
3. При повторном добавлении скрипта `appendFreshScript` видит его в кэше и пропускает
4. **Решение:** Очищать `scriptCache` при удалении скриптов или в `purgeAllScripts()`

## 2025-12-23: Реализация исправлений (Шаг 4)
- Модифицирован `dom.ts`:
  - Добавлен метод `removeScriptFromCache(hash: string)` для удаления хэша из кэша
  - Добавлен метод `clearScriptCache()` для полной очистки кэша
  - Обновлён `removeExistingScript()` для вызова `removeScriptFromCache()` при удалении скрипта
  - Экспортирован `clearScriptCache()` для использования в других модулях
- Обновлён `runScripts.ts`:
  - Добавлен импорт `clearScriptCache`
  - Добавлен вызов `clearScriptCache()` после `purgeAllScripts()` для очистки кэша скриптов
- Сборка проекта успешно завершена (`npm run build`)

## Следующие шаги:
1. Протестировать изменения (Шаг 5)